前期的规划
一、 需求确认：你想做成什么样的“剧本杀”？
1. 宽泛：核心产品形态
  - 单人模式：用户扮演主角，AI 扮演所有 NPC 和主持人（类似互动小说）。
- 剧本生成方式：
  - 预设剧本：你提供几个精品模版，AI 在框架内发挥。
  - 全随机生成：用户给一句话（如“在 2077 年的火锅店”），AI 实时生成万字大纲、角色背景。
3. 细节：AI DM 的“脑子”怎么长？
- 记忆管理：AI 如何记得 1 小时前张三撒过的谎？（涉及 Vector Database / Long-term Memory）。
短期记忆（Session Context）：存储最近 10-20 条对话。这是 AI 的“即时反应区”，保证它能接住话茬。
长久记忆（Vector DB）：将之前的关键对话片段嵌入（Embedding）到向量数据库（如 Milvus 或 Redis Stack）。
- 实现逻辑：当玩家说“我之前没去过机舱”时，后端先去向量库搜索关键词“张三+机舱+行踪”，如果检索到他之前说过“我 8 点在机舱”，AI 就会触发“质疑逻辑”。
实体属性记忆（Entity Memory）：这非常关键。你需要维护一个 Redis Hash，记录每个玩家当前的“人设状态”。
- 例如：Player:ZhangSan -> { "current_lie": ["8点行踪"], "inventory": ["扳手"], "trust_level": 50 }。
- 节奏控制：AI 不能一次把凶手说出来。它需要一个“进度条”逻辑，根据玩家搜证进度推动阶段跳转。
AI DM 不能像个话痨一样一次性把底裤翻出来，它需要一个**“状态驱动机”**。
- 有限状态机 (Finite State Machine, FSM)：利用 Spring State Machine 定义游戏的生命周期。
  - 阶段划分：INTRO (开场) -> ROUND_1_INVESTIGATION (第一轮搜证) -> ROUND_1_DEBATE (第一轮辩论) -> ... -> VOTING (投票)。
- 关键指标 (Progress Triggers)：
  - AI 内部维护一个进度数值 $P \in [0, 100]$。
  - 当玩家发现关键线索 $C_1$ 时，$P = P + 15$。
  - 逻辑锁：只有当 $P > 40$ 时，AI 才会允许进入“第二轮线索发放”。如果玩家一直在摸鱼，AI DM 会通过 NPC 角色进行提示（引导）。
- 考虑工作流或者图之类的算法，框定流程。
- 逻辑校验：如果玩家的行为逻辑不通（比如在真空太空站里抽烟），AI 能否及时纠正或演化剧情？
多Agent架构：
1. 执行 Agent (The Actor)：负责扮演 DM 陪聊。
2. 裁判 Agent (The Judge)：隐藏在幕后，负责审查执行 Agent 的输出。
实现方式：在 Prompt 中预设 World Schema。
- 如果玩家动作是 Action: Smoke，裁判 Agent 会先校验环境参数 Environment: Vacuum。
- 校验不通过，裁判 Agent 会拦截响应，强制要求执行 Agent 调整回复：“你试图掏出打火机，但意识到这里没有氧气，周围的船员像看傻子一样看着你。”

---
二、 技术实现：用 Java 怎么搭这套戏台？
既然你擅长 Java，建议基于 Spring Boot 3.x 和最新的 AI 框架 来实现。
1. 核心技术选型
模块	推荐方案	理由
AI 编排	LangChain4j	Java 版的 LangChain，完美对接 GPT-4o, DeepSeek, Claude。
实时通信	Spring WebSocket	剧本杀需要多端同步，实时推送 DM 的话术。
状态机	Spring State Machine	严格管理游戏状态（准备中、搜证轮、投票轮）。
存储	Redis + MySQL	MySQL 存剧本库，Redis 存当前游戏的活跃状态和会话上下文。
向量搜索	Milvus / Pinecone	用于存储庞大的背景设定，AI 根据玩家提问检索相关信息。
2. 关键难点：Prompt Engineering
你需要设计三类 Prompt：
1. 编剧 Prompt：负责生成逻辑自洽的剧本。
2. 主持人 Prompt：负责控制流程、引导发言、维持氛围。
3. NPC Prompt：负责模拟不同性格的角色，保守秘密。
3. agent架构设计（多agent设计）
3.1 AI 玩家 Agent (The Roleplayers)
要让 AI “真的变成一个玩家”，关键在于**“信息差”和“动机驱动”**。
- 私有记忆（Private Knowledge）：它只拥有自己的剧本内容，不知道真相或其他人的秘密。
- 目标系统（Goal System）：给它设定“胜算指标”。例如：凶手 Agent 的目标是“误导他人”；侦探 Agent 的目标是“找出时间线矛盾”。
- 决策逻辑：它不应只是被动回答，而应在每轮对话中判断：“我现在应该质疑谁？” 或 “我是否需要撒谎？”。
3.2 DM Agent (The Game Master)
- 职责：负责氛围渲染、下发线索、强制推进阶段。
- 控制权：DM 是唯一可以改写游戏全局状态（Game State）的 Agent。
3.3 监控/裁判 Agent (The Monitor/Judge)
这是最关键的逻辑层。
- 合规性检查：拦截玩家（包括 AI 和真人）超脱人设的行为（如：现代人穿越到古代剧本说冷笑话）。
- 逻辑一致性：记录所有人的证词。如果 AI 玩家 A 说了 B，十分钟后又说了非 B，监控 Agent 应当记录这一矛盾点作为潜在的推理线索，或者直接提示其 OOC（Out of Character）。

---
三、细节细化
如何把ai变成一个“真正的玩家”
4. 思考逻辑环 (Thinking Loop)
不要让 AI 直接生成回复，而是给它一个**“内心独白”**的步骤：
1. Receive：收到别人的发言。
2. Evaluate：对比自己的私有剧本和当前目标。
3. Inner Monologue（隐藏）：“他刚才提到了 8 点，但我 8 点在作案，我得编个谎话。”
4. Output（公开）：“噢，我 8 点在花园看花，没见过他。”
2. 状态机驱动
利用 Spring State Machine 定义游戏阶段。
每个 Agent 的行为模式受当前 State 限制。例如在 Discussion 阶段，AI 玩家被激活“反驳”逻辑；在 Search 阶段，被激活“分析线索”逻辑

---
四、ideas
- Ai 玩家可以预设几种人格类型（比如冷静推理型、热情外向型、冷漠型等等），玩起来可能会更有意思

---

五、 预想成果：最终交付什么？
为了让这个项目在简历上或作品集里更亮眼，你可以分阶段实现以下成果：
MVP 阶段（最小可行性产品）
- 一个 Web 页面。
- 输入背景词，生成简单的角色卡。
- 用户可以和 AI 扮演的 DM 交互，完成一次简单的“搜证-推凶”流程。



---
游戏形式
- AI生成剧本（后续有时间再做拓展） + 经典剧本（MVP）
- 多人游戏（人数按剧本算，不足的AI玩家补齐）
- 剧本类型：推理本+还原本（这里还没确定，最初版本先集中做一到两个）
- 不同类型，游戏流程不同。
- 组人和选本 -》分角色和读剧本 -》搜证和剧情发展 -》结束方式（推理本按答题式结算或许更好）

---

更加详细的游戏步骤
游戏准备： 
1.所有玩家随机抽取自己的人物剧本。（前端显示：桌上放置剧本，开始游戏后，顺时针一个一个发送文件，需要具有文件从中间快速旋转至各个用户的面前的动画，剧本旋转到用户面前的时候，动画显示剧本从桌上翻页打开并从平面变换至用户面前，背景添加模糊效果，聚焦展示剧本内容，用md渲染剧本，剧本是md格式的），剧本从对应的文件夹中读取，在Script/对应剧本文件夹/Role/里面，用户在开始游戏前可以选择自己的角色（此时不能显示任何剧本，只有选择角色后，剧本开始发放动画后才能查看）
2.完成角色分配之后，玩家分别阅读自己的剧本。（游戏过程中只能看自己剧本，严禁看其他人的剧本） 
3.玩家需要准备纸和笔或者手机以供记录线索。
4.开始游戏。
胜利条件：投对凶手且不被其他人怀疑为凶手即可获得游戏胜利。 
游戏流程： 
1.游戏开始：玩家分别融入自己的角色。
2.自我介绍：各位玩家依次进行简单的自我介绍。
3.第一轮圆桌讨论：
- 玩家围绕圆桌进行第一次讨论，限时  xx 分钟。
- 玩家公布剧本上第一阶段必须公布的信息，各自发言，推理凶手。
- 除凶手外所有玩家都不能撒谎。 
4.听取证言：玩家可以选择任意一名其他玩家申请私聊，该玩家可拒绝。（侦探 邀请私聊所有玩家不可拒绝）限时  xx 分钟。结束后侦探投出第一票。 
5.第二轮圆桌讨论：同第一轮圆桌讨论，限时  xx 分钟。
6.最后的发言：
- 侦探一对一完毕后，所有玩家围绕圆桌，依次发言，阐述自己的看法（怀疑是凶手的玩家，理由，凶手的作案手法等）。 
- 当一名玩家发言时，其他人不能打断，该阶段玩家不能相互讨论，限时 xx 分钟。 
7.投票阶段：每名玩家将自己认为是凶手的玩家名字写在纸上，然后同时用手 指向自己在纸上写的那名玩家（不可弃权）。侦探一票记  2 票，得票最高者出局 （票数相同时同时出局）。 
8.公布真相：由凶手叙述自己的作案动机和作案过程。
---

涉及的对象（mysql表格设计 + 向量数据库设计）
Mysql表格
- 游戏（每一局是一个新对象，记录这局游戏的基本信息，包括游戏类型，人机数量，）
- 剧本
- 游戏对话
- 玩家状态表（每局游戏，记录每个玩家的基本信息，包括人or机等等信息）
- 线索表格（线索的解锁条件，）
- 状态记录表（记录当前状态：轮数、轮到谁发言、游戏阶段、时间、谁知道了什么等等信息）
- 角色档案（存储每个角色的不为人知的秘密、作案动机、时间线。AI玩家需要以此为“真理”
- 内心独白记录：记录AI玩家在说话前的“思考过程”（不给别的玩家看），由于后续的复盘和调优AI逻辑与提示词）
- 信任度表（每个ai玩家需要记录对其他人的怀疑程度，这会影响AI玩家在讨论环节的倾向性）

- 

向量数据库设计
- 每个AI玩家都应该有一个向量数据库，存储该玩家对对话的动态影响（比如说某个玩家说过什么什么）

---

重要问题设计
如何确保DM正确主持？
- 不要全盘把对话丢入
解决方案：状态机 + 事件驱动。
- 把对话流交给一个轻量级的**“摘要 Agent”**，它负责每隔 5 轮生成一个“当前战况摘要”。
- DM 只读：剧本大纲 + 摘要 Agent 的总结 + 当前阶段目标（可以存储在状态记录表中）。DM还要读线索记录表，确保不以往发布线索
- 例如：DM 的 Prompt 里写着：“当前目标是引导玩家搜寻书房。如果玩家卡住了，给出提示。”

---
如何让AI玩家能够逻辑自洽？
- 静态线索：DM发布的重要线索，存到mysql中，确保能够无误的读取
- 动态线索：对话产生的线索，存在向量数据库，比如xx透露的行踪