# AI剧本杀项目架构设计

## 一、线索关联库设计与可见性管理

### 1. 线索关联库可见性确定

**可见性管理机制：**

1. **基于玩家发现状态**
   - 每个玩家（包括AI）维护一个已发现线索列表
   - 线索关联的可见性基于玩家是否已发现相关线索
   - 只有当玩家同时发现了两个相关线索时，才能看到它们之间的关联

2. **可见性字段设计**
   - **可见性级别**：
     - `PUBLIC`：所有玩家可见
     - `DISCOVERED`：仅已发现相关线索的玩家可见
     - `PRIVATE`：仅特定玩家可见（如侦探专属线索）

3. **关联强度计算**
   - 基于线索内容的语义相似度
   - 基于线索在时间线上的接近程度
   - 基于线索与案件核心的相关程度
   - 范围：0-100，值越高关联越紧密

### 2. 保证AI玩家只能在现有线索间找关联

**实现方案：**

1. **查询过滤机制**
   - 向量数据库查询时添加过滤条件：
     ```sql
     WHERE player_id = ? AND (visibility = 'PUBLIC' OR (visibility = 'DISCOVERED' AND discovered_by = ?))
     ```

2. **线索发现状态跟踪**
   - 在MySQL中维护`player_clues`表，记录每个玩家已发现的线索
   - 向量数据库查询前先检查玩家的线索发现状态

3. **AI推理约束**
   - 在AI提示词中明确约束：只能基于已发现的线索进行推理
   - 法官Agent校验AI玩家的推理是否基于已发现的线索

4. **关联发现机制**
   - 当玩家发现新线索时，系统自动计算与已发现线索的关联
   - 只向玩家展示基于其已发现线索的关联

## 二、向量数据库管理方案

### 1. 向量数据库存储策略

**推荐方案：统一存储，按权限访问**

**理由：**
- **存储效率**：避免数据冗余，节省存储空间
- **管理简化**：集中管理，减少维护成本
- **一致性保证**：确保所有Agent访问的数据一致
- **扩展性强**：便于后续功能扩展

### 2. 权限管理实现

1. **数据分区**
   - 使用Milvus的分区功能，按游戏ID分区
   - 每个游戏实例的数据存储在独立分区

2. **字段级权限**
   - 在向量数据中添加`access_control`字段
   - 存储可访问该数据的玩家ID列表

3. **查询时过滤**
   - 每次查询时添加权限过滤条件
   - 确保玩家只能访问有权限的数据

4. **缓存策略**
   - 为每个AI玩家缓存其有权访问的向量数据
   - 提高查询效率，减少向量数据库负载

### 3. 内存管理优化

1. **短期记忆**：存储在Redis中，保留最近10-20条对话
2. **中期记忆**：存储在向量数据库中，保留游戏过程中的重要信息
3. **长期记忆**：存储在向量数据库中，包含角色背景、剧本信息等

## 三、搜证交互设计

### 1. 纯Web环境的搜证形式

**推荐交互形式：场景探索 + 线索问答**

**具体实现：**

1. **场景探索界面**
   - 显示当前可探索的场景列表（如书房、客厅、花园等）
   - 玩家点击进入场景后，显示场景描述和可交互元素

2. **线索发现机制**
   - **主动搜索**：玩家点击场景中的可疑元素触发
   - **问答形式**：玩家可向DM提问关于场景的问题
   - **时间限制**：每轮搜证有时间限制，增加紧张感

3. **线索展示**
   - 发现线索后，弹出线索卡片，显示线索名称和描述
   - 线索卡片可收藏到玩家的线索簿中
   - 重要线索可触发AI玩家的反应或对话

4. **搜证流程**
   1. DM提示当前搜证阶段开始
   2. 玩家选择探索的场景
   3. 玩家在场景中搜索或提问
   4. 系统根据玩家行为生成线索
   5. 玩家确认线索，线索加入线索簿
   6. 搜证时间结束，进入讨论阶段

### 2. 搜证交互示例

**场景：书房**

```
[DM] 现在进入搜证阶段，你可以探索以下场景：书房、客厅、花园、厨房
[玩家] 我要去书房看看
[DM] 你走进书房，看到书架上摆满了书，书桌上有一台笔记本电脑，角落里有一个保险箱
[玩家] 我检查一下笔记本电脑
[DM] 你打开笔记本电脑，发现屏幕上显示着一份未完成的研究报告，报告中提到了一种新型毒药
[系统] 你发现了线索：【研究报告】
[玩家] 我想看看保险箱
[DM] 保险箱需要密码才能打开，你注意到保险箱上有一些划痕，似乎是尝试输入密码时留下的
[玩家] 密码可能是什么？
[DM] 你回忆起之前的对话，记得有人提到过书房主人的生日是1990年5月15日
[玩家] 我输入密码19900515
[DM] 保险箱打开了，里面有一份遗嘱和一把钥匙
[系统] 你发现了线索：【遗嘱】和【神秘钥匙】
```

## 四、项目整体架构设计

### 1. 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                            前端层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  Web界面 (React/Vue)  ── 游戏客户端 ── WebSocket通信              │
├─────────────────────────────────────────────────────────────────────┤
│                            后端层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  API网关    │  │  游戏服务   │  │  AI服务     │  │  状态服务   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│                            中间层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  消息队列   │  │  缓存系统   │  │  向量存储   │  │  搜索引擎   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│                            存储层                                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │  MySQL      │  │  Redis      │  │  Milvus     │  │  文件存储   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 2. 核心组件设计

#### 2.1 前端层

**核心模块：**

1. **游戏客户端**
   - 剧本选择界面
   - 角色分配界面（带动画效果）
   - 剧本阅读界面（MD渲染）
   - 游戏主界面（对话、搜证、讨论）
   - 投票界面
   - 结局展示界面

2. **WebSocket客户端**
   - 实时消息推送
   - 游戏状态更新
   - 多Agent对话同步

3. **前端状态管理**
   - 游戏状态管理
   - 玩家数据管理
   - 线索簿管理

#### 2.2 后端层

**核心服务：**

1. **API网关**
   - 请求路由
   - 认证授权
   - 流量控制

2. **游戏服务**
   - 游戏流程管理
   - 玩家管理
   - 剧本管理
   - 线索管理

3. **AI服务**
   - Agent管理
   - AI对话处理
   - 推理引擎
   - 记忆管理

4. **状态服务**
   - 状态机管理
   - 事件处理
   - 进度跟踪

#### 2.3 中间层

**核心组件：**

1. **消息队列**（RabbitMQ）
   - Agent间通信
   - 事件广播
   - 异步任务处理

2. **缓存系统**（Redis）
   - 会话管理
   - 热点数据缓存
   - 游戏状态缓存

3. **向量存储**（Milvus）
   - 对话向量库
   - 角色记忆库
   - 线索关联库

4. **搜索引擎**（Elasticsearch）
   - 剧本检索
   - 线索检索
   - 对话历史检索

#### 2.4 存储层

**核心存储：**

1. **MySQL**
   - 游戏数据
   - 剧本数据
   - 玩家数据
   - 线索数据
   - 对话记录

2. **Redis**
   - 会话数据
   - 游戏状态
   - 短期记忆

3. **Milvus**
   - 向量数据
   - 长期记忆
   - 语义关联

4. **文件存储**
   - 剧本文件
   - 场景图片

## 五、Agent架构设计

### 1. Agent类型与职责

| Agent类型 | 职责 | 访问权限 | 通信内容 |
|-----------|------|----------|----------|
| **DM Agent** | 游戏主持、氛围渲染、线索发放、阶段推进 | 全部 | 游戏状态、线索发放、阶段转换 |
| **Player Agent** | 扮演游戏角色、参与讨论、隐藏秘密 | 角色记忆+已发现线索 | 对话、决策、质疑 |
| **Judge Agent** | 逻辑校验、行为监控、一致性检查 | 全部 | 校验请求、逻辑判断 |
| **Summary Agent** | 对话摘要、关键信息提取、进度评估 | 全部 | 事件摘要、进度更新 |

### 2. Agent通信机制

**通信流程：**

1. **消息产生**
   - 玩家输入 → 消息队列
   - Agent决策 → 消息队列
   - 状态变化 → 消息队列

2. **消息路由**
   - 消息队列根据消息类型和目标Agent路由
   - 支持点对点和发布/订阅模式

3. **消息处理**
   - Agent接收消息 → 处理逻辑 → 生成响应
   - 重要消息触发状态更新

4. **响应分发**
   - Agent响应 → 消息队列 → 目标接收者

### 3. Agent决策流程

**Player Agent决策流程：**

1. **输入接收**：收到其他玩家的发言或游戏事件
2. **记忆检索**：从向量数据库检索相关信息
3. **状态评估**：评估当前游戏状态和个人目标
4. **内心独白**：生成思考过程（存储到内心独白表）
5. **决策生成**：基于信任度和已发现线索生成决策
6. **行为执行**：执行决策（发言、质疑、搜证等）
7. **记忆更新**：将新信息更新到向量数据库

## 六、搜证系统详细设计

### 1. 搜证流程设计

**阶段划分：**

1. **搜证准备**
   - DM提示搜证阶段开始
   - 系统展示可探索场景
   - 玩家选择探索顺序

2. **场景探索**
   - 玩家进入场景，系统展示场景描述
   - 玩家可选择交互元素或提问
   - 系统根据玩家行为生成线索

3. **线索发现**
   - 发现线索后展示线索卡片
   - 线索加入玩家线索簿
   - 系统记录线索发现事件

4. **关联分析**
   - 系统自动分析新线索与已发现线索的关联
   - 向玩家展示基于其已发现线索的关联

5. **搜证结束**
   - 搜证时间结束或玩家主动结束
   - 系统汇总本轮搜证结果
   - 进入讨论阶段

### 2. 搜证交互设计

**交互形式：**

1. **场景选择**
   - 可视化场景列表
   - 场景状态指示（已探索/未探索）

2. **场景交互**
   - 场景描述展示
   - 可交互元素高亮
   - 点击交互或输入问答

3. **线索展示**
   - 线索卡片动画效果
   - 线索详细信息查看
   - 线索分类管理

4. **关联提示**
   - 线索关联可视化展示
   - 关联强度指示
   - 基于关联的推理提示

### 3. 搜证系统技术实现

**前端实现：**
- React/Vue组件化开发
- 场景探索界面使用SVG或Canvas绘制
- 线索卡片使用CSS动画效果
- WebSocket实时通信

**后端实现：**
- 场景管理API
- 线索生成逻辑
- 关联分析算法
- 状态机集成

**AI集成：**
- 场景描述生成
- 线索发现触发
- 关联分析支持
- 搜证引导

## 七、技术栈选择

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **前端** | React | 18.x | 前端界面开发 |
| **前端** | Socket.io | 4.x | WebSocket通信 |
| **前端** | Redux | 4.x | 状态管理 |
| **前端** | Tailwind CSS | 3.x | 样式管理 |
| **后端** | Spring Boot | 3.x | 后端框架 |
| **后端** | Spring WebSocket | 6.x | 实时通信 |
| **后端** | Spring State Machine | 3.x | 状态管理 |
| **后端** | LangChain4j | 0.24+ | AI交互 |
| **存储** | MySQL | 8.x | 关系型数据存储 |
| **存储** | Redis | 7.x | 缓存和会话管理 |
| **存储** | Milvus | 2.3+ | 向量数据存储 |
| **存储** | Elasticsearch | 8.x | 搜索引擎 |
| **消息** | RabbitMQ | 3.12+ | 消息队列 |
| **部署** | Docker | 20.10+ | 容器化部署 |
| **部署** | Kubernetes | 1.25+ | 容器编排 |

## 八、部署架构

### 1. 开发环境

```
┌────────────────────────────────────┐
│          开发机器                  │
├────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐ │
│  │  前端开发   │  │  后端开发   │ │
│  └─────────────┘  └─────────────┘ │
├────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐ │
│  │  MySQL      │  │  Redis      │ │
│  └─────────────┘  └─────────────┘ │
├────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐ │
│  │  Milvus     │  │  RabbitMQ   │ │
│  └─────────────┘  └─────────────┘ │
└────────────────────────────────────┘
```

### 2. 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                       负载均衡                             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  API服务    │  │  API服务    │  │  API服务    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  游戏服务   │  │  AI服务     │  │  状态服务   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  RabbitMQ   │  │  Redis集群  │  │  Milvus集群 │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐                        │
│  │  MySQL主从  │  │  ES集群     │                        │
│  └─────────────┘  └─────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

## 九、性能优化策略

### 1. 前端优化

- **代码分割**：按需加载组件
- **缓存策略**：合理使用浏览器缓存
- **WebSocket优化**：消息压缩、批量发送
- **渲染优化**：虚拟列表、防抖节流

### 2. 后端优化

- **API优化**：合理设计API，减少请求次数
- **数据库优化**：索引设计、查询优化
- **缓存策略**：多级缓存、热点数据预加载
- **异步处理**：非关键任务异步执行

### 3. 向量存储优化

- **索引优化**：根据数据类型选择合适的索引
- **分区策略**：按游戏ID和时间分区
- **查询优化**：合理使用过滤条件，减少搜索空间
- **内存管理**：热数据缓存，冷数据磁盘存储

### 4. 部署优化

- **容器化**：使用Docker容器化部署
- **自动扩缩容**：基于负载自动调整实例数
- **监控告警**：实时监控系统状态，及时告警
- **灾备方案**：数据备份、多可用区部署

## 十、安全性设计

### 1. 前端安全

- **XSS防护**：输入验证、输出编码
- **CSRF防护**：Token验证
- **敏感信息保护**：不在前端存储敏感信息

### 2. 后端安全

- **认证授权**：JWT认证、基于角色的权限控制
- **输入验证**：参数校验、SQL注入防护
- **API限流**：防止暴力攻击
- **日志审计**：关键操作日志记录

### 3. 数据安全

- **数据加密**：敏感数据加密存储
- **访问控制**：严格的数据访问权限
- **备份策略**：定期数据备份
- **传输安全**：HTTPS加密传输

## 十一、扩展性设计

### 1. 功能扩展

- **剧本系统**：支持自定义剧本、剧本市场
- **角色系统**：支持角色定制、技能系统
- **游戏模式**：支持多人模式、团队模式
- **AI系统**：支持自定义AI人格、AI训练

### 2. 技术扩展

- **微服务拆分**：将游戏服务拆分为多个微服务
- **多语言支持**：国际化、多语言界面
- **多端支持**：移动端、桌面端适配
- **第三方集成**：社交平台、支付系统集成

## 十二、结论

本架构设计采用分层架构，结合现代Java技术栈和AI技术，为AI剧本杀项目提供了一个完整、可扩展的解决方案。通过合理的向量数据库管理、Agent架构设计和搜证系统实现，确保了游戏的沉浸感和推理的逻辑性。

同时，架构设计考虑了性能优化、安全性和扩展性，为项目的长期发展奠定了基础。在实际开发中，可以根据具体需求和资源情况，对架构进行适当调整和优化。